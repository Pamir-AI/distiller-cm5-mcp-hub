#!/bin/sh
set -e

# Clean up after complete removal
if [ "$1" = "purge" ]; then
    echo "Purging Distiller MCP Hub..."
    
    # Stop and disable the service if it's running
    systemctl stop mcp.service 2>/dev/null || true
    systemctl disable mcp.service 2>/dev/null || true
    
    # Remove configuration files
    echo "Removing configuration files..."
    rm -rf /etc/distiller-mcp-hub
    
    # Remove log directory and files
    echo "Removing log files..."
    rm -rf /var/log/distiller-mcp-hub
    
    # Remove all virtual environments
    echo "Removing virtual environments..."
    rm -rf /opt/distiller-mcp-hub/.venv
    rm -rf /opt/distiller-mcp-hub/projects/camera-mcp/.venv
    rm -rf /opt/distiller-mcp-hub/projects/mic-mcp/.venv
    rm -rf /opt/distiller-mcp-hub/projects/speaker-mcp/.venv
    
    # Remove uv cache and config for distiller user
    echo "Removing uv cache and configuration..."
    if getent passwd distiller >/dev/null 2>&1; then
        # Get distiller user's home directory
        DISTILLER_HOME=$(getent passwd distiller | cut -d: -f6)
        rm -rf "$DISTILLER_HOME/.cache/uv" 2>/dev/null || true
        rm -rf "$DISTILLER_HOME/.local/share/uv" 2>/dev/null || true
        rm -rf "$DISTILLER_HOME/.config/uv" 2>/dev/null || true
    fi
    
    # Remove root uv cache (in case it was created during installation)
    rm -rf /root/.cache/uv 2>/dev/null || true
    rm -rf /root/.local/share/uv 2>/dev/null || true
    rm -rf /root/.config/uv 2>/dev/null || true
    
    # Remove application directory
    echo "Removing application files..."
    rm -rf /opt/distiller-mcp-hub
    
    # Remove systemd service file
    echo "Removing systemd service..."
    rm -f /lib/systemd/system/mcp.service
    
    # Remove symlinks and management scripts
    echo "Removing symlinks..."
    rm -f /usr/bin/manage_mcp_service.sh
    
    # Remove uv binaries if they were installed by this package
    echo "Removing uv binaries installed by this package..."
    if [ -f /usr/local/bin/uv ]; then
        rm -f /usr/local/bin/uv
    fi
    if [ -f /usr/local/bin/uvx ]; then
        rm -f /usr/local/bin/uvx
    fi
    
    # Remove temporary files created by the service
    echo "Removing temporary files..."
    if [ -d /tmp/tts_output ]; then
        rm -rf /tmp/tts_output
    fi
    for tmpfile in /tmp/distiller-mcp-*; do
        if [ -e "$tmpfile" ]; then
            rm -rf "$tmpfile"
        fi
    done
    
    # Remove any runtime files
    rm -rf /run/distiller-mcp-hub 2>/dev/null || true
    
    # Remove any cache files
    rm -rf /var/cache/distiller-mcp-hub 2>/dev/null || true
    
    # Remove any lock files
    rm -f /var/lock/distiller-mcp-hub* 2>/dev/null || true
    
    # Remove distiller user and group
    echo "Removing distiller user and group..."
    if getent passwd distiller >/dev/null 2>&1; then
        deluser --system distiller 2>/dev/null || true
    fi
    if getent group distiller >/dev/null 2>&1; then
        delgroup --system distiller 2>/dev/null || true
    fi
    
    # Reload systemd
    echo "Reloading systemd..."
    systemctl daemon-reload 2>/dev/null || true
    
    # Remove documentation
    echo "Removing documentation..."
    rm -rf /usr/share/doc/distiller-mcp-hub
    
    echo "Distiller MCP Hub has been completely removed."
fi

#DEBHELPER# 
