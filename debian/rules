#!/usr/bin/make -f

%:
	dh $@ --with python3

override_dh_auto_install:
	# Install Python packages
	dh_auto_install
	
	# Create config and log directories
	mkdir -p debian/distiller-mcp-hub/opt/distiller-mcp-hub
	mkdir -p debian/distiller-mcp-hub/lib/systemd/system
	mkdir -p debian/distiller-mcp-hub/usr/bin
	mkdir -p debian/distiller-mcp-hub/var/log/distiller-mcp-hub
	mkdir -p debian/distiller-mcp-hub/etc/distiller-mcp-hub

override_dh_install:
	dh_install

override_dh_fixperms:
	dh_fixperms
	# Set proper permissions for distiller user
	chmod 755 debian/distiller-mcp-hub/opt/distiller-mcp-hub
	chmod 644 debian/distiller-mcp-hub/opt/distiller-mcp-hub/mcp_config.json
	chmod 644 debian/distiller-mcp-hub/lib/systemd/system/mcp.service
	
	# Make Python scripts executable
	chmod +x debian/distiller-mcp-hub/opt/distiller-mcp-hub/run_all_mcps.py
	chmod +x debian/distiller-mcp-hub/opt/distiller-mcp-hub/projects/camera-mcp/server.py
	chmod +x debian/distiller-mcp-hub/opt/distiller-mcp-hub/projects/mic-mcp/server.py
	chmod +x debian/distiller-mcp-hub/opt/distiller-mcp-hub/projects/speaker-mcp/server.py
	
	# Make wrapper script executable
	chmod +x debian/distiller-mcp-hub/opt/distiller-mcp-hub/venv_wrapper.sh
	
	# Make management script executable
	chmod +x debian/distiller-mcp-hub/usr/bin/manage_mcp_service.sh
	
	# Ensure pyproject.toml files are readable
	chmod 644 debian/distiller-mcp-hub/opt/distiller-mcp-hub/pyproject.toml
	chmod 644 debian/distiller-mcp-hub/opt/distiller-mcp-hub/projects/camera-mcp/pyproject.toml
	chmod 644 debian/distiller-mcp-hub/opt/distiller-mcp-hub/projects/mic-mcp/pyproject.toml
	chmod 644 debian/distiller-mcp-hub/opt/distiller-mcp-hub/projects/speaker-mcp/pyproject.toml
	
	# Ensure uv.lock files are readable if they exist
	[ -f debian/distiller-mcp-hub/opt/distiller-mcp-hub/uv.lock ] && chmod 644 debian/distiller-mcp-hub/opt/distiller-mcp-hub/uv.lock || true
	[ -f debian/distiller-mcp-hub/opt/distiller-mcp-hub/projects/camera-mcp/uv.lock ] && chmod 644 debian/distiller-mcp-hub/opt/distiller-mcp-hub/projects/camera-mcp/uv.lock || true
	[ -f debian/distiller-mcp-hub/opt/distiller-mcp-hub/projects/mic-mcp/uv.lock ] && chmod 644 debian/distiller-mcp-hub/opt/distiller-mcp-hub/projects/mic-mcp/uv.lock || true
	[ -f debian/distiller-mcp-hub/opt/distiller-mcp-hub/projects/speaker-mcp/uv.lock ] && chmod 644 debian/distiller-mcp-hub/opt/distiller-mcp-hub/projects/speaker-mcp/uv.lock || true

override_dh_installdocs:
	dh_installdocs
	# Install additional documentation
	cp README.md debian/distiller-mcp-hub/opt/distiller-mcp-hub/
	cp MCP_SERVICE_README.md debian/distiller-mcp-hub/opt/distiller-mcp-hub/ 
